//@version=6
indicator("Custom ZigZag - All Lines", overlay=true)

// Ввод параметров
deviation = input.float(1.0, title="Price Deviation for Reversals (%)", minval=0.1, step=0.1)
depth = input.int(5, title="Pivot Legs", minval=1)

// Переменные для хранения текущего направления и точек поворота
var bool isUpTrend = true
var float lastPivot = na
var int lastPivotBar = 0
var float[] pivotValues = array.new_float(0)
var int[] pivotTimes = array.new_int(0) // Используем time для координат линий

// Определение локальных максимумов и минимумов
isHigh = high >= ta.highest(high, depth)
isLow = low <= ta.lowest(low, depth)

// Логика ZigZag
if na(lastPivot)
    // Начальная точка
    if isHigh
        lastPivot := high
        lastPivotBar := bar_index
        isUpTrend := true
        array.push(pivotValues, lastPivot)
        array.push(pivotTimes, time)
    else if isLow
        lastPivot := low
        lastPivotBar := bar_index
        isUpTrend := false
        array.push(pivotValues, lastPivot)
        array.push(pivotTimes, time)
else
    if isUpTrend
        if high > lastPivot
            lastPivot := high
            lastPivotBar := bar_index
            array.set(pivotValues, array.size(pivotValues) - 1, lastPivot)
            array.set(pivotTimes, array.size(pivotTimes) - 1, time)
        else if low < lastPivot * (1 - deviation / 100) and bar_index - lastPivotBar >= depth
            lastPivot := low
            lastPivotBar := bar_index
            isUpTrend := false
            array.push(pivotValues, lastPivot)
            array.push(pivotTimes, time)
    else
        if low < lastPivot
            lastPivot := low
            lastPivotBar := bar_index
            array.set(pivotValues, array.size(pivotValues) - 1, lastPivot)
            array.set(pivotTimes, array.size(pivotTimes) - 1, time)
        else if high > lastPivot * (1 + deviation / 100) and bar_index - lastPivotBar >= depth
            lastPivot := high
            lastPivotBar := bar_index
            isUpTrend := true
            array.push(pivotValues, lastPivot)
            array.push(pivotTimes, time)

// Отображение всех линий ZigZag с использованием времени
if array.size(pivotValues) >= 2
    for i = 0 to array.size(pivotValues) - 2
        line.new(x1=array.get(pivotTimes, i), y1=array.get(pivotValues, i), 
                 x2=array.get(pivotTimes, i + 1), y2=array.get(pivotValues, i + 1), 
                 xloc=xloc.bar_time, color=color.blue, width=1)

// Отображение точек поворота
plot(lastPivot == high ? high : na, style=plot.style_cross, color=color.green, title="High Pivot")
plot(lastPivot == low ? low : na, style=plot.style_cross, color=color.red, title="Low Pivot")